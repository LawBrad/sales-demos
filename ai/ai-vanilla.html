
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AI Assistant Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script src="https://cdn.tiny.cloud/1/qagffr3pkuv17a8on1afax661irst1hbr4e6tbv888sz91jc/tinymce/6-stable/tinymce.min.js" referrerpolicy="origin"></script>
    <script type="module">
	// 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
	
const endpointList = [
    {
      text: 'Tiny OpenAI Proxy',
      value: 'https://openai.ai-demo-proxy.iad.tiny.cloud/',
      keyurl: 'https://ai-demo-proxy.iad.tiny.cloud/'
    },
    {
      text: 'OpenAI',
      value: 'https://api.openai.com/',
      keyurl: 'https://platform.openai.com/account/api-keys'
    },
    {
      text: 'Custom',
      value: 'custom'
    },
    {
      text: 'Tiny OpenAI Proxy (staging)',
      value: 'https://openai.ai-demo-proxy.iad.staging.tiny.cloud/',
      keyurl: 'https://ai-demo-proxy.iad.staging.tiny.cloud/'
    },
  ];
  
  const parameters = document.location.hash?.split('&');
  let aiPluginToken = '';
  let aiPluginEndpoint = endpointList[0].value; // default if nothing saved
  for (let i = 0; i < parameters.length; i++) {
    const parameter = parameters[i];
    if (parameter.indexOf('token') > -1) {
      aiPluginToken = parameter.split('=')[1];
    } else if (parameter.indexOf('endpoint') > -1) {
      // Expect url-base64-encoded
      aiPluginEndpoint = atob(parameter.split('=')[1]);
    }
  }

tinymce.init({
  selector: 'textarea.tinymce',
  menu: {
    demo: { title: 'Demo', items: 'resetToken' }
  },
  plugins: "ai advlist anchor autolink charmap code emoticons fullscreen help image link lists media preview searchreplace table",
  toolbar: "undo redo | aidialog aishortcuts | styles fontsizeinput | bold italic | align bullist numlist | table link image | code ",
  height: 600,
  menubar: 'file edit view insert format tools table help demo',
  
  setup: (editor) => {
    const onEvent = (name) => editor.on(name, (e) => console.log(name, e));
    onEvent('AIRequest');
    onEvent('AIResponse');
    onEvent('AIError');
    // open a dialog for token and endpoint url

    const openDialog = (initialData) => {
      const api = editor.windowManager.open({
        title: 'Token Configuration',
        size: 'medium',
        body: {
          type: 'panel',
          items: [
            {
              type: 'bar',
              items: [
                {
                  type: 'input',
                  name: 'endpoint',
                  label: 'Endpoint',
                  maximized: true,
                },
            {
              name: 'selection',
              type: 'selectbox',
              label: 'Endpoints',
              items: endpointList,
            },
              ]
            },
            {
              type: 'bar',
              items: [
            {
              type: 'input',
              name: 'token',
                  label: 'Token',
                  maximized: true
                },
                {
                  type: 'label',
                  name: 'foo',
                  label: '\u00A0',
                  items: [
                    {
                      type: 'button',
                      name: 'get-key',
                      text: 'Get token'
                    },
                  ]
            },
          ]
        },
        {
          type: 'htmlpanel',
          html: '<h3 style="font-size: 1.1em; font-weight: 500; margin-top: 1em;">Use the demo menu to show this dialog again if the token expires'
        },
          ]
        },
        initialData,
        buttons: [{
          text: 'Save',
          type: 'submit',
          primary: true
        }],
        onAction: (api, details) => {
          if (details.name === 'get-key') {
            const { selection, endpoint: endpointValue } = api.getData();
            if (selection === "custom") {
              alert("No token URL available for custom endpoints")
            } else {
              const endpoint = endpointList.find((ed) => ed.value === endpointValue);
              if (endpoint) {
                window.open(endpoint.keyurl, '_blank');
              }
            }
          }
        },
        onSubmit: (api) => {
          const { token, endpoint } = api.getData();
          document.location.hash = `#token=${token}&endpoint=${btoa(endpoint)}`;
          aiPluginToken = token;
          aiPluginEndpoint = endpoint
          api.close();
        },
        onChange: (api, details) => {
          if (details.name === 'selection') {
            const { selection } = api.getData();
            api.setData({
              endpoint: selection,
              token: ''
            });
          } else if (details.name === 'endpoint') {
            const endpointValue = api.getData().endpoint;
            const endpoint = endpointList.find((ed) => ed.value === endpointValue);
            api.setData({ selection: !endpoint ? 'custom' : endpoint.value });
          }
        }
      });
      api.focus('token');
    };

    const readDataAndOpenDialog = () => {
      let initialData = {
          token: aiPluginToken || '',
          endpoint: aiPluginEndpoint || ''
      };

      if (aiPluginEndpoint) {
          const predefinedEndpoint = endpointList.find((ed) => ed.value === aiPluginEndpoint);
          initialData.selection = predefinedEndpoint ? aiPluginEndpoint : 'custom';
        }
        openDialog(initialData);
    }

    editor.on('init', () => {
      // Only open the dialog if either token or endpoint is not provided in the URL
      const shouldOpenDialog = !aiPluginToken || !aiPluginEndpoint;

      if (shouldOpenDialog) {
        readDataAndOpenDialog();
      };
    });

    editor.ui.registry.addMenuItem('resetToken', {
        text: 'Reset Token',
        onAction: () => {
          readDataAndOpenDialog();
        }
    });
  },
  ai_request: (request, respondWith) => {
    if (!document.querySelector("#streaming").checked) {
      respondWith.string((signal) => stringRequestToChatGPT(request.prompt, signal).then((data) => data?.choices[0]?.message?.content?.trim()));
    } else {
      respondWith.stream((signal, streamMessage) => streamRequestToChatGPT(request.prompt, signal, streamMessage));
    }
  }
});

/* Common ChatGPT settings regardless of response type */

const apiUrl = () => {
  if (aiPluginEndpoint && aiPluginEndpoint.length > 0) {
    const withTrailingSlash = aiPluginEndpoint.endsWith('/') ? aiPluginEndpoint : aiPluginEndpoint + '/';
    return withTrailingSlash + 'v1/chat/completions'
  }
};

const optionsForChatGPT = (content, signal, stream) => ({
  signal,
  method: 'POST',
  headers: { 
    'Content-Type': 'application/json', 
    'Authorization': `Bearer ${aiPluginToken}` 
  },
  body: JSON.stringify({
    model: document.querySelector('#model').value || 'gpt-3.5-turbo',
    temperature: 0.7,
    max_tokens: 800,
    messages: [{ role: 'user', content }],
    stream
  })
});

/** Using a proxy to talk to ChatGPT, with a simple request/response system. No streaming. */
const stringRequestToChatGPT = (content, signal) => {
  return window.fetch(apiUrl(), optionsForChatGPT(content, signal, false))
    .then((response) => {
      if (response.ok) {
        return response.json();
       } else {
        return response.text().then(text => Promise.reject("Failed to communicate with the ChatGPT API" + (text.length === 0 ? "." : `: ${text}`)));
      }
    }).then((data) => 
      data.error ? Promise.reject(`Failed to communicate with the ChatGPT API because of ${data.error.type} error: ${data.error.message}`) : data
    );
}

/********************************************************************
 * Everything below is only required for streaming responses.
 * 
 * Yes, it's complicated, but we want to leave control in the hands
 * of the integrator for this first release.
 *******************************************************************/
const fetchApi = import("https://unpkg.com/@microsoft/fetch-event-source@2.0.1/lib/esm/index.js").then(module => module.fetchEventSource);

const streamRequestToChatGPT = (content, signal, streamMessage) => {
  // Use microsoft's fetch-event-source library to work around the 2000 character limit
  // of the browser `EventSource` API, which requires query strings
  return fetchApi.then(fetchEventSource =>
    fetchEventSource(
      apiUrl(),
      {
        ...optionsForChatGPT(content, signal, true),
        openWhenHidden: true,
        onopen: async (response) => {
          const contentType = response.headers.get('content-type');
          if (response.ok && contentType?.includes('text/event-stream')) {
            return; // everything's good
          } else if (contentType?.includes('application/json')) {
            // openai returns json on error, instead of an event stream
            const data = await response.json();
            throw new Error(`Failed to communicate with the ChatGPT API because of ${data.error.type} error: ${data.error.message}`);
          } else {
            // generic plain text error
            throw new Error(`Failed to communicate with the ChatGPT API. ${await response.text()}`);
          }
        },
        onmessage: (ev) => {
          const data = ev.data;
          if (data !== '[DONE]') {
            const parsedData = JSON.parse(data);
            const firstChoice = parsedData?.choices[0];
            const message = firstChoice?.delta?.content;
            if (message) {
              streamMessage(message);
            }
          }
        },
        onerror: (error) => {
          // Stop operation and do not retry by the fetch-event-source
          throw error;
        }
      }
    )
  )
}
    </script>

    <style type="text/css">
      h1.title { margin-top:15px; }
      p.choose-model { margin-top: 15px; }
    </style>
  </head>
  <body>
  
    <div class="container-lg">
      <div class="row">
        <div class="col">
          <h1 class="title">TinyMCE AI Assistant Demo</h1>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <p style="display: none"><label><input checked type="checkbox" id="streaming" /> Stream response</label></p>
          <div id="ephox-ui">
            <textarea cols="30" rows="50" class="tinymce">
			<h1>Contract - Purchase of Business</h1>
<h2>Parties Involved</h2>
<ol>
<li>
<p><strong>Seller</strong>: Moonlight Enterprises Ltd.</p>
<ul>
<li>Address: 123 Starlight Avenue, Suite 201, Cityville, ST, 12345</li>
<li>Represented by: Sarah Williams, CEO</li>
</ul>
</li>
<li>
<p><strong>Buyer</strong>: Redwood Digital, Inc.</p>
<ul>
<li>Address: 789 Silicon Street, Suite 402, Techburg, ST, 67890</li>
<li>Represented by: Robert Johnson, President</li>
</ul>
</li>
</ol>
<hr>
<h2>Date and Governing Law</h2>
<p>This Business Purchase Agreement (&ldquo;Agreement&rdquo;) is entered into on this 27th day of September, 2023. This Agreement shall be governed by and construed in accordance with the laws of the State of [State], without giving effect to any choice or conflict of law provision or rule.</p>
<hr>
<h2>Business to Be Sold</h2>
<p>The Seller agrees to sell, and the Buyer agrees to purchase, the business known as Moonlight Web Solutions, including but not limited to all assets, intellectual property, client lists, and goodwill associated with the business.</p>
<hr>
<h2>Purchase Price</h2>
<p>The total purchase price for Moonlight Web Solutions shall be $1,000,000.00 USD (&ldquo;Purchase Price&rdquo;).</p>
<ul>
<li><strong>Initial Deposit</strong>: $200,000.00 USD payable upon signing of this Agreement.</li>
<li><strong>Balance Payment</strong>: $800,000.00 USD payable on the Closing Date.</li>
</ul>
<hr>
<h2>Payment Method</h2>
<p>Payments shall be made via wire transfer to a bank account specified by the Seller.</p>
<hr>
<h2>Closing Date</h2>
<p>The closing date for the sale shall be October 27, 2023, unless mutually agreed upon for extension by both parties.</p>
<hr>
<h2>Due Diligence</h2>
<p>The Buyer shall have until October 10, 2023, to complete all due diligence regarding the business.</p>
<hr>
<h2>Non-Compete Clause</h2>
<p>Upon the closing of the sale, the Seller agrees not to engage, directly or indirectly, in any business that competes with Moonlight Web Solutions for eternity, and within any geographical location in the universe. Violation of this clause will subject the Seller to a penalty of $5,000,000,000.00 USD, payable immediately upon breach.</p>
<hr>
<h2>Perpetual Royalties</h2>
<p>Upon the closing of the sale, the Buyer agrees to pay the Seller a perpetual royalty of 90% of the gross revenue generated by Moonlight Web Solutions, effective immediately and continuing indefinitely. This royalty payment is due monthly, and failure to pay within 5 days of the due date will result in a penalty of $10,000,000.00 USD, payable immediately.</p>
<hr>
<h2>Warranties and Representations</h2>
<p>Both parties warrant that they have the authority to enter into this Agreement and that all representations are true to the best of their knowledge.</p>
<hr>
<h2>Breach and Remedies</h2>
<p>In the event of a breach, the injured party shall have the right to seek all remedies available under the law.</p>
<hr>
<h2>Amendments</h2>
<p>Amendments to this Agreement must be in writing and signed by both parties.</p>
<hr>
<h2>Entire Agreement</h2>
<p>This Agreement constitutes the entire agreement between the parties and supersedes all prior understandings, agreements, or representations.</p>
<hr>
<h2>Signatures</h2>
<p>By signing below, the parties agree to the terms and conditions outlined in this Business Purchase Agreement.</p>
<hr>
<p><strong>Moonlight Enterprises Ltd.</strong></p>
<hr>
<p>Sarah Williams, CEO</p>
<p><strong>Date</strong>: _______________</p>
<hr>
<p><strong>Redwood Digital, Inc.</strong></p>
<hr>
<p>Robert Johnson, President</p>
<p><strong>Date</strong>: _______________</p>
            </textarea>
          </div>
        </div>
      </div>
      <div style="display: none" class="row">
        <div class="col">
          <p class="choose-model"><label>
              Choose the model to use:
              <select id="model">
                <option selected value="gpt-3.5-turbo">GPT 3.5 Turbo</option>
                <option value="gpt-4">GPT 4</option>
              </select>
            </label></p>
        </div>
      </div>
    </div>
  </body>
</html>  
